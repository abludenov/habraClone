# Подключение PostgreSQL через Docker

Устанавливаем Docker с [официального сайта](https://docs.docker.com/get-docker/)

Далее открываем терминал и проверяем что Docker установлен, доступен и смотрим его версию:
```
docker -v
```

Установку PostgreSQL, создание контейнера и его запуск можно совместить в одну большую, но вполне понятную команду
```
docker run --name habra_clone -e POSTGRES_DB=habra_clone -e POSTGRES_USER=root -e POSTGRES_PASSWORD=root -d -p 5433:5432 postgres
```

- run - запуск нового контейнера

- --name - имя контейнера

- -e - задаём переменную контейнера

    - POSTGRES_BD=habra_clone - имя базы данных

    - POSTGRES_USER=root - имя пользователя

    - POSTGRES_PASSWORD=root - пароль пользователя

- -d - запуск контейнера в фоновом режиме

- -p 5433:5432 - порты для соединения локального ресурса:контейнера

Для запуска и остановки контейнера используем команды:

```
docker start habra_clone

docker stop habra_clone
```
Далее производим подключение к контейнеру с запуском утилиты bash
```
docker exec -it habra_clone bash
```
---
#Подключение и создание базы данных
Подключаемся к базе данных

```
psql -h localhost -p 5432 habra_clone -U root
```
- -h - имя хоста

- -p - порт подключения

-   [ имя БД ]

- -U - имя пользователя


Теперь находимся в самой базе данных

Отобразить список БД:
```
\l
```

Коннектимся с базой данных:

```
\c habra_clone
```

Дисконнект с базой данных

```
\q
```
--------------
#Настройка базы данных в IDEA

Справой стороны открываем вертикальную вкладку ***Database***<br/>
Далее по цепочке "+" -> Data Source -> PostgreSQL

В поля User, Password и Database вводим соответствующие значения, что вводили ранее. После этого нажимаем кнопку "Test Connection" и если видим зелёную галочку, то всё OK!

#Сохранение бэкапа базы данных из Docker контейнера

Делаем резервную копию
```
Linux
docker exec habra_clone pg_dump -u root --password=root habra_clone | gzip > habra_clone.sql.gz

Windows
docker exec -it habra_clone pg_dump -u root habra_clone > {свой путь строчными символами}\habra_clone.sql
```
- exec - выполнение команды внутри контейнера
- pg_dump - дамп базы данных
- -u - пользователь
- -password - пароль

Восстанавливаем базу данных в контейнере из дампа:
```
Linux
gunzip < habra_clone.sql.gz | docker exec -i habra_clone psql -U root -d habra_clone

Windows
docker exec -i habra_clone psql -U root -d habra_clone < {свой путь строчными символами}\habra_clone.sql
```

# Habra Clone

## Введение
Данное приложение разрабатывается, как некий клон известного нам web-ресурса [habr.com][1].
Разумеется, мы не располагаем достоверной информацией о реализации его полного функционала
поэтому, мы можем оперировать лишь теми данными, которые можем почерпнуть, как пользователи ресурса.

Сам проект хоть и подразумевается, как "клон", но, тем не менее, допускаются некоторые расхождения с "оригиналом",
т.к. у нас нет строгого ТЗ. Некоторые упрощения или даже оптимизация приложения вполне допустимы, но должны быть
заранее согласованы с командой и team-lead'ом в частности.

[1]: https://habr.com/ru/feed/

## Какими сущностями оперирует приложение

---
### User
Сущность [**User**][2] описывает пользователя приложения в момент регистрации в приложении. С этим процессом связаны следующие поля:
1. `username` - уникальный логин пользователя;
2. `email` - уникальный почтовый адрес пользователя;
3. `password` - пароль от аккаунта;
4. `enabled` - данное поле отвечает за статус аккаунта "активен/заблокирован";
5. `roles`  **User** участвует в процессах аутентификации и авторизации через это поле;

Помимо этого, в **User** хранится часть информация о социальной активности в web-ресурсе через следующие поля:
6. `badges` - хранит информацию об уникальных баджах (ачивках) пользователя на ресурсе;
7. `followers` - список подписчиков пользователя;
8. `followings` - список пользователей, на которых подписан данный User;
9. `invitedUsers` - список пользователей, которые были приглашены данным User'ом.

[2]: src/main/java/com/javamentor/habra_clone/model/User.java

--- 

### Role
Сущность [**Role**][3] непосредственно участвует в процессах аутентификации и авторизации, и связана односторонней связью ***ManyToMany***
с **User**, в которой **User** является владельцем этой связи.
Сущность имеет следующие поля:

1. `name` - описывает имя роли;
2. `authorities` Каждая "роль" подразумевает доступ к определённому набору **"привилегий"**, которые являются ни чем иным, как доступным функционалом для каждой отдельно взятой роли.

[3]: src/main/java/com/javamentor/habra_clone/model/Role.java

---

### Address
Сущность [**Address**][address] описывает заявленный пользователем адрес местонахождения, содержит следующие поля:
1. `country` - хранит информацию об указанной пользователем Стране, является обязательным полем для заполнения;
2. `region` - хранит информацию об указанном пользователем регионе;
3. `city` - хранит информацию об указанном пользователем городе.


   [address]: src/main/java/com/javamentor/habra_clone/model/Address.java

---

### Topic
Сущность [**Topic**][topic] - Это пост написанный пользователем. Так же пост может быть написан совместно несколькими
пользователями, или от лица компании. Содержит следующие поля:
1. `title` - название поста/заголовка;
2. `authors` - информация об авторах и соавторах;
3. `published` - дата публикации;
4. `content` - хранит информацию о содержании публикации;
5. `votes` - количество проголосовавших юзеров. Отдельно можно вывести количество положительных и отрицательных голосов;
6. `views` - количество просмотров;
7. `userBookmarks` - закладки на публикацию.

[topic]: src/main/java/com/javamentor/habra_clone/model/Topic.java

---

### Hub
Сущность [**Hub**][hub] - Это группа на сайте хабра. Каждый отдельный хаб может иметь различную тематику,
и включать в себя множество авторов и компаний. Так же насчитывает в себе индивидуальный рейтинг среди всех хабов.
Содержит следующие поля:
1. `title` - название хаба;
2. `icon` - аватар хаба;
3. `tags` - тэги хаба;
4. `topics` - список топиков;
5. `usersContributions` - вклад в хабы;
6. `usersHubs` - на какие хабы подписан.

[hub]: src/main/java/com/javamentor/habra_clone/model/Hub.java

---

### Badge
Сущность [**Badge**] [11] хранит информацию об уникальных баджах (ачивках) пользователя на ресурсе;

1. `title` - название баджа-ачивки;
2. `icon` - иконка баджа-ачивки;
3. `usersHaveBadge` - Сет юзеров, обладающих бадж-ачивкой.

[11]: src/main/java/com/javamentor/habra_clone/model/Badge.java

---

### Comment
Сущность [**Comment**][6] хранит информацию о комментариях и реакциях юзеров на публикации.

1. `content` - содержание публикации;
2. `published` - дата публикации;
3. `positiveVotes` - юзеры которые лайкнули;
4. `negativeVotes` - юзеры которые дизлайкнули;
5. `moderate` - видимый ли комментарий;
6. `topic` - к какому топику относится коммент;
7. `user` - кто оставил комментарий;
8. `mainComment` - Id Комментария верхнего порядка. Если null, то он и есть самый верхний комментарий.

[6]: src/main/java/com/javamentor/habra_clone/model/Comment.java

---

### Profile
Сущность [**Profile**][001] является сопровождающей информацией о пользователе, представленной на его <br>
личной странице на сайте.

1. `avatar` - аватар пользователя;
2. `gender` - указанный пол пользователя, сопровождается вложенным [**enum'ом**][010];
3. `actualName` - настоящее имя пользователя;
4. `birthDay` - дата рождения пользователя;
5. `aboutUser` - биография пользователя, "о себе";
6. `registeredDate` - дата регистрации;
7. `specialization` - текстовое поле с указанием компетенций пользователя;
8. `contactInfo` - ссылки на сторонние веб-ресурсы пользователя;
9. `speakersCompanies` - компании спикерами которых является этот User;
10. `companiesFollower`- компании подписчики;
11. `userLocation` - место жительства пользователя;
12. `userCompany` - место работы пользователя;
13. `user` - непосредственный пользователь, которому принадлежит профиль.

[001]: src/main/java/com/javamentor/habra_clone/model/Profile.java
[010]: src/main/java/com/javamentor/habra_clone/model/GenderEnum.java

---

### Company
Сущность [**Company**][20] описывает аккаунты компаний, которые занимаются корпоративным блогом.

1. `companyName` - название компании;
2. `UTRnumber` - номер ИНН компании, необходимый для регистрации на сервисе;
3. `companySite` - сайт компании;
4. `companyScale` - количество человек, работающих в компании;
5. `companyAvatar` - аватар компании;
6. `companyRating` - рейтинг компании, динамически меняющийся параметр, по умолчанию равен нулю;
7. `aboutCompany` - биография компании, "о компании";
8. `companyAdmins` - пользователи с правами админа компании;
9. `companyModerators` - пользователи с правами модератора компании;
10. `companyContacts` - ссылки на сторонние веб-ресурсы компании;
11. `companyHubs` - список Хабов, в которые совершила вклад компания;
12. `companyBlog` - блог компании, её публикации на ресурсе;
13. `companyTags` - список компетенций/отраслей компании;
14. `companyFollowers` - подписчики компании.

[20]: src/main/java/com/javamentor/habra_clone/model/Company.java

--- 

### UserActivity

Сущность [**UserActivity**][5] описывает активность юзера, каждую конкретную (написал пост, комментарий, лайкнул и т.д.). Каждый экземпляр UserActivity – это конкретное действие пользователя (лог). Эта сущность имеет следующие поля:
1. ` lastActivity ` типа LocalDateTime – это дата и время действия;
2. ` changeUp ` типа Boolean – это повышение (true) или понижение (false) рейтинга пользователя при данной активности;
3. ` user ` типа User – поле, связанное с сущностью User и показывающее принадлежность активности к конкретному пользователю.
4. ` activityType `типа ActivityType - поле  
[5]: src/main/java/com/javamentor/habra_clone/model/UserActivity.java

--- 

### Tag

Сущность [**Tag**][11] описывает вкладки-теги на главной странице сайта. Они структурируют написанные посты (Topics) по категориям. Сущность довольно простая и содержит в себе следующие поля:
1. ` title` типа String – название вкладки;
2. ` topics` – поле, связанное с сущностью Topic и представляющее собой Set<Topic>, в котором хранится список постов по этому тэгу.

[11]: src/main/java/com/javamentor/habra_clone/model/Tag.java

--- 

### Rating

Сущность [**Rating**][12] описывает параметр Рейтинга - показателя вклада пользователя в развитие сайта. Это очень интересный показатель, динамически меняющийся со временем и действиями пользователя.
Написание постов, комментариев и т.д. увеличивает рейтинг, бездействие в течении определённого количества времени - снижает его. Формула подсчёта рейтинга неизвестна и, похоже, нужно будет самостоятельно
создать алгоритм работы с рейтингом. Сущность хранит в себе не только текущий параметр рейтинга, но и историю его изменений вместе с причинами. Эти изменения и запись причин реализуются через специальный класс RatingManager, который нужно реализовать в сервисном слое.

ВАЖНО!!! В сервисном слое нужно будет создать специальный класс, управляющий изменениями рейтинга у пользователей - RatingManager и выгрузить весь функционал работы с рейтингом в него.

Сущность имеет следующие поля:

1. `value` типа Double – текущее значение рейтинга;
2. `reason` типа String – текстовое описание причины изменения рейтинга. Текстовое описание должно быть стандартизировано на уровне RatingManager'а и появляться из него;
3. `userActivity ` – поле, связанное с сущностью UserActivity и показывающее принадлежность изменения рейтинга к конкретной активности.

[12]: src/main/java/com/javamentor/habra_clone/model/Rating.java

--- 

### Karma

Сущность [**Karma**][13] описывает параметр Кармы - показатель одобрения действий пользователя со стороны других пользователей сайта. 
Этот показатель меняется другими пользователями, т.е. один пользователь может поменять карму другому, нажав соответсвующую кнопку. Один пользователь может поменять карму другому только один раз, а затем только отменить/изменить своё решение.
Например, пользователь Billy выражает категорическое неодобрение пользователю Van и уменьшает ему карму. Если Billy и Van помирятся, тогда Billy может изменить своё решение, отозвать изменение кармы и добавить её в адрес пользователя Van.
Кроме того, один раз за всё время, пользователь может обнулить свою карму, начав жизнь с чистого листа.
Сущность хранит в себе не только текущий параметр кармы, но и историю её изменений вместе с причинами. Эти изменения и запись причин реализуются через специальный класс KarmaManager, который нужно реализовать в сервисном слое.

ВАЖНО!!! В сервисном слое нужно будет создать специальный класс, управляющий изменениями кармы у пользователей - KarmaManager и выгрузить весь функционал работы с кармой в него.

Сущность имеет следующие поля:

1. ` value` типа Double – текущее значение кармы
2. ` reason` типа String – текстовое описание причины изменения кармы. Текстовое описание должно быть стандартизировано на уровне KarmaManager'а и появляться из него.
3. ` editorUser ` – поле, описывающее пользователя, КОТОРЫЙ поменял карму другому
4. ` editedUser ` – поле, описывающее пользователя, КОТОРОМУ поменяли карму

[13]: src/main/java/com/javamentor/habra_clone/model/Karma.java

--- 

### Authority

Сущность [**Authority**][14] описывает разрешения на конкретные действия пользователя в рамках сайта. Это очень ёмкая сущность, из которой затем собирается Role - именно поэтому важно прописать все возможные действия на сайте, от чтения до редактирования постов или даных пользователя.
В дальнейшем из этой сущности можно как собрать Role и использовать в настройках Security, так и работать напрямую с разрешениями через hasAuthority. Это позволяет гибко настраивать возможные действия для каждого конкретного типа пользователей или доступов к страницам.

Сущность имеет следующие поля:

1. ` name` типа String – имя привилегии/описание. Используется в Security и контроллерах.

[14]: src/main/java/com/javamentor/habra_clone/model/Authority.java

--- 

### ActivityType

Сущность [**ActivityType**][15] описывает количество рейтинга, назначаемое за определенную активность,
Сущность имеет следующие поля:

1. ` type` элемент enum типа NameActivityType описание типа активности.
2. ` changeCoefficient ` типа Double, описывает количество, на которое изменится рейтинг, в случае определенного типа активности.

[15]: src/main/java/com/javamentor/habra_clone/model/ActivityType.java

---

### NameActivityType

Сущность [**NameActivityType**][16] enum, который хранит в себе типы активности Usera,

[16]: src/main/java/com/javamentor/habra_clone/model/NameActivityType.java

---

# Настройка Swagger в Spring Boot

Swagger - это фреймворк для спецификации RESTful API. Его прелесть заключается в том, что он дает возможность не только интерактивно просматривать спецификацию, но и отправлять запросы – так называемый Swagger UI.

Также возможно сгенерировать непосредственно клиента или сервер по спецификации API Swagger, для этого понадобится Swagger Codegen.

### Основные подходы

Swagger имеет два подхода к написанию документации:

- Документация пишется на основании вашего кода.

    - Данный подход позиционируется как "очень просто". Нам достаточно добавить несколько зависимостей в проект, добавить конфигурацию и уже мы будем иметь нужную документацию, хоть и не настолько описанной какою мы хотели.

    - Код проекта становиться не очень читабельным от обилия аннотаций и описания в них.

    - Вся документация будет вписана в нашем коде (все контроллеры и модели превращаются в некий Java Swagger Code)
    - Подход не советуют использовать, если есть возможности, но его очень просто интегрировать.

- Документация пишется отдельно от кода.

    - Данный подход требует знать синтаксис Swagger Specification.

    - Документация пишется либо в YAML/JSON файле, либо в редакторе Swagger Editor.


### Подключение

Для приложения на Spring Boot, для подключения swagger достаточно добавить всего лишь одну зависимость (пример для maven):

```
<dependency>
    <groupId>io.springfox</groupId>
    <artifactId>springfox-boot-starter</artifactId>
    <version>3.0.0</version>
</dependency>
```
(пример для gradle)
```
implementation("io.springfox:springfox-boot-starter:3.0.0")
```

Также мы должны добавиь конфигурационный класс для корректной работы Swagger.
Все настройки swagger производятся с помощью методов объекта Docket. 

```java
@Configuration
public class SpringFoxConfig {
    @Bean
    public Docket api() {
        return new Docket(DocumentationType.SWAGGER_2)
                .select()
                .apis(RequestHandlerSelectors.any())
                .paths(PathSelectors.any())
                .build();
    }
}
```

Теперь, если у нас есть хотя бы один эндпоинт, мы можем просмотреть всю информацию о нём, открыв страницу http://127.0.0.1:8080/swagger-ui/ 
(обратите внимание, что слеш в конце обязателен). 
По каждому эндпоинту можно посмотреть тип запроса (GET, POST и т.п.), 
набор входных параметров, формат ответа, возможные коды ошибок http (200, 401, 403, 404 и т.п.). 
А если нажать кнопку «Try it out», то мы сможем отправить тестовый запрос прямо через веб-интерфейс.


### Описание контроллера и метода

Теперь рассмотрим, как настраивать отображаемую информацию. Предположим, есть у нас такой контроллер()

```java
@RestController
@RequestMapping("/v1/habra_clone")
@Api(description = "Контроллер для работы с API пользователей")
public class UserController {

    private final UserService userService;

    public UserController(UserService userService) {
        this.userService = userService;
    }

    @GetMapping
    @ApiOperation("Получение списка всех пользователей")
    public List<User> getAllUsers() {
        return userService.findAll();
    }
  }
```
Он содержит единственный обработчик GET-запроса, который при обращении по адресу 
http://127.0.0.1:8181/v1/habra_clone будет возвращать ответ в формате json.
Сам формат ответа определяется дата-классом User:
```java
public class User {
    private Long id;
    private String username;
    private String email;
    private List<String> roles;
   /* other fields, constructor, getters and setters*/
}
```
Аннотация @Api с параметром description позволяет задавать описание для контроллера, а @ApiOperation - для метода


Для скрытия методов или их параметров из документации используется аннотация *@ApiIgnore*
```java
 @DeleteMapping("/{id}")
    @ApiIgnore
    public void delete(@PathVariable Long id)
```
###Как скрыть лишние эндпоинты
Проекты, основанные на Spring Boot, часто могут содержать служебные эндпоинты
Эти эндпоинты не имеют отношения к бизнес-логике приложения и поэтому их лучше также скрыть из документации.
Для этого определяется базовый пакет, который будет сканировать Swagger, и указывается в качестве параметра в методе *apis()* объекта Docket 
в нашем конфигурационном классе

```
apis(RequestHandlerSelectors.basePackage("com.javamentor.habra_clone.controller"))
```

### Авторизация

Для авторизации в приложении используйте следующие данные:

    Роль Admin:
        логин:Admin
        пароль:admin

    Роль Moderator:
        логин:Moderator
        пароль:moderator

    Роль User:
        логин:User
        пароль:user

